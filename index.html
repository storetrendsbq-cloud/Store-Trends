function doPost(e) {
  try {
    // Log inicial
    console.log('üöÄ INICIANDO PROCESAMIENTO DE PEDIDO');
    
    // Conectar con la hoja de c√°lculo
    var sheet = SpreadsheetApp.openById('10Fu9RzSgkLu-jIa714zkeBDtMjc6kplbPmQlqi5qFOw').getActiveSheet();
    console.log('‚úÖ Hoja conectada');
    
    // Obtener datos
    var rawData = e.postData.contents;
    console.log('üì® Datos recibidos (primeros 500 chars):', rawData.substring(0, 500));
    
    // Parsear JSON
    var requestData = JSON.parse(rawData);
    console.log('üìù Tipo de datos:', typeof requestData);
    console.log('üîë Claves del objeto:', Object.keys(requestData));
    
    // EXTRAER LOS DATOS - m√©todo m√°s flexible
    var orderData;
    
    if (requestData.orderData) {
      orderData = requestData.orderData;
      console.log('‚úÖ Usando orderData');
    } else if (requestData.metadata) {
      orderData = requestData;
      console.log('‚úÖ Usando datos directos');
    } else {
      console.log('‚ùå No se pudo encontrar orderData');
      throw new Error('Estructura de datos no reconocida');
    }
    
    console.log('üë§ Cliente:', orderData.customer?.name || 'No name');
    console.log('üõçÔ∏è N√∫mero de items:', orderData.items?.length || 0);
    
    // VERIFICAR DATOS ESENCIALES
    if (!orderData.customer || !orderData.items || orderData.items.length === 0) {
      throw new Error('Datos esenciales faltantes');
    }
    
    // PREPARAR HOJA SI EST√Å VAC√çA
    var lastRow = sheet.getLastRow();
    if (lastRow === 0) {
      var headers = [
        'Consecutivo', 'N√∫mero de Pedido', 'Fecha', 'Producto',
        'Cantidad', 'Precio Unitario', 'Total Producto', 'Marca',
        'Cliente', 'Email', 'Tel√©fono', 'Direcci√≥n', 
        'Ciudad', 'Observaciones', 'Forma de Pago', 'Subtotal', 
        'Env√≠o', 'Total'
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      console.log('üìã Encabezados creados');
      lastRow = 1;
    }
    
    // OBTENER √öLTIMO CONSECUTIVO
    var consecutivo = 1;
    if (lastRow > 1) {
      var lastConsecutivo = sheet.getRange(lastRow, 1).getValue();
      consecutivo = parseInt(lastConsecutivo) + 1;
    }
    console.log('üî¢ Consecutivo:', consecutivo);
    
    // PREPARAR FILAS NUEVAS
    var newRows = [];
    
    for (var i = 0; i < orderData.items.length; i++) {
      var item = orderData.items[i];
      
      var row = [
        consecutivo + i,  // Consecutivo
        orderData.metadata?.orderNumber || 'STBQ-' + new Date().getTime(),  // N√∫mero de pedido
        orderData.metadata?.orderDate || new Date().toLocaleString(),  // Fecha
        item.nombre || 'Producto sin nombre',  // Producto
        item.quantity || item.cantidad || 1,  // Cantidad
        item.precio?.actual || item.precio_unitario || 0,  // Precio unitario
        (item.quantity || item.cantidad || 1) * (item.precio?.actual || item.precio_unitario || 0),  // Total producto
        item.marca || 'Generico',  // Marca
        orderData.customer.name || '',  // Cliente
        orderData.customer.email || '',  // Email
        orderData.customer.phone || '',  // Tel√©fono
        orderData.customer.address || '',  // Direcci√≥n
        orderData.customer.city || '',  // Ciudad
        orderData.customer.notes || '',  // Observaciones
        orderData.metadata?.paymentMethod || orderData.customer?.paymentMethod || 'No especificado',  // Forma de pago
        orderData.metadata?.subtotal || 0,  // Subtotal
        orderData.metadata?.shipping || 0,  // Env√≠o
        orderData.metadata?.total || 0  // Total
      ];
      
      newRows.push(row);
      console.log('üì¶ Producto ' + (i + 1) + ':', item.nombre || 'Sin nombre');
    }
    
    // INSERTAR FILAS
    if (newRows.length > 0) {
      sheet.getRange(lastRow + 1, 1, newRows.length, newRows[0].length).setValues(newRows);
      console.log('‚úÖ ' + newRows.length + ' filas insertadas');
      
      // Forzar guardado
      SpreadsheetApp.flush();
    }
    
    console.log('üéâ PEDIDO COMPLETADO EXITOSAMENTE');
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Pedido registrado correctamente'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('‚ùå ERROR:', error.toString());
    console.error('üìä Stack:', error.stack);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error: ' + error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Funci√≥n simple de prueba
function testSimple() {
  var testData = {
    orderData: {
      metadata: {
        orderNumber: "TEST-123",
        orderDate: "ahora",
        paymentMethod: "Contra entrega",
        subtotal: 100000,
        shipping: 0,
        total: 100000
      },
      customer: {
        name: "Test Cliente",
        email: "test@test.com",
        phone: "3001234567",
        address: "Calle Test",
        city: "Bogot√°",
        notes: "Test simple"
      },
      items: [
        {
          nombre: "Perfume Test",
          quantity: 1,
          precio: { actual: 100000 },
          marca: "Test"
        }
      ]
    }
  };
  
  var e = {
    postData: {
      contents: JSON.stringify(testData)
    }
  };
  
  var result = doPost(e);
  console.log('Resultado test:', result.getContent());
  return result;
}
