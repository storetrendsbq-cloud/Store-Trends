<script>
    // ===== CONFIGURACI√ìN WOMPI =====
    const WOMPI_PUBLIC_KEY = 'pub_test_Mv1l7L1UJH55WaT7ScivNlQ5AUaLjp7Q';
    const WOMPI_API_URL = 'https://sandbox.wompi.co/v1/transactions/';

    async function checkPendingOrder() {
        console.log('üîç Buscando pedido pendiente...');
        
        // 1. Buscar en localStorage y sessionStorage
        let pendingOrder = null;
        
        try {
            pendingOrder = localStorage.getItem('pendingWompiOrder') || 
                          sessionStorage.getItem('pendingWompiOrder');
        } catch (error) {
            console.error('‚ùå Error accediendo al almacenamiento:', error);
        }
        
        if (!pendingOrder) {
            showResult('error', 
                'No encontramos pedidos pendientes. Esto puede significar que:<br><br>' +
                '‚Ä¢ Tu pedido ya fue procesado correctamente<br>' +
                '‚Ä¢ No se guard√≥ informaci√≥n del pedido<br>' +
                '‚Ä¢ O realizaste el pago en otro dispositivo/navegador<br><br>' +
                'Si realizaste un pago, por favor cont√°ctanos por WhatsApp.'
            );
            return;
        }
        
        let orderData;
        try {
            orderData = JSON.parse(pendingOrder);
            console.log('üìã Datos del pedido encontrado:', orderData);
        } catch (error) {
            console.error('‚ùå Error parseando datos del pedido:', error);
            showResult('error', 'Error al leer la informaci√≥n del pedido. Por favor cont√°ctanos.');
            return;
        }
        
        // üî• OBTENER ID PARA VERIFICAR (m√∫ltiples opciones)
        let transactionIdToCheck = null;
        
        if (orderData.wompiId) {
            transactionIdToCheck = orderData.wompiId;
            console.log('üîç Usando ID real de Wompi:', transactionIdToCheck);
        } else if (orderData.ourReference) {
            transactionIdToCheck = orderData.ourReference;
            console.log('üîç Usando nuestra referencia:', transactionIdToCheck);
        } else if (orderData.metadata && orderData.metadata.wompiReference) {
            transactionIdToCheck = orderData.metadata.wompiReference;
            console.log('üîç Usando referencia de metadata:', transactionIdToCheck);
        }
        
        if (!transactionIdToCheck) {
            console.error('‚ùå No se pudo encontrar ID para verificar:', orderData);
            showResult('error', 
                'No encontramos informaci√≥n suficiente para verificar tu transacci√≥n.<br><br>' +
                'Por favor cont√°ctanos por WhatsApp con cualquier informaci√≥n que tengas.'
            );
            return;
        }
        
        console.log('üîç ID a verificar:', transactionIdToCheck);
        showResult('warning', 'Buscando informaci√≥n de tu transacci√≥n... <div class="loading"></div>');
        
        try {
            // 2. Verificar estado con API de Wompi
            console.log('üîç Verificando transacci√≥n Wompi:', transactionIdToCheck);
            const transaction = await verifyTransactionWithWompi(transactionIdToCheck);
            console.log('üì° Respuesta de Wompi:', transaction);
            
            if (transaction && transaction.status === 'APPROVED') {
                // 3. Procesar pedido aprobado
                await processRecoveredOrder(orderData, transaction);
            } else if (transaction) {
                showResult('error', 
                    `Tu transacci√≥n est√° en estado: <strong>${transaction.status}</strong><br><br>` +
                    `Si el pago fue exitoso pero ves este mensaje, por favor cont√°ctanos.`
                );
            } else {
                showResult('error', 
                    'No pudimos obtener informaci√≥n de tu transacci√≥n.<br><br>' +
                    'Esto puede significar que:<br>' +
                    '‚Ä¢ El pago no se complet√≥<br>' +
                    '‚Ä¢ La transacci√≥n fue cancelada<br>' +
                    '‚Ä¢ Ocurri√≥ un error en el proceso<br><br>' +
                    'Por favor cont√°ctanos por WhatsApp para verificar manualmente.'
                );
            }
        } catch (error) {
            console.error('‚ùå Error verificando pedido:', error);
            
            if (error.message.includes('404')) {
                showResult('error', 
                    'No encontramos la transacci√≥n en Wompi.<br><br>' +
                    'Esto puede significar que:<br>' +
                    '‚Ä¢ El pago no se complet√≥<br>' +
                    '‚Ä¢ La transacci√≥n fue cancelada<br>' +
                    '‚Ä¢ El ID de transacci√≥n es incorrecto<br><br>' +
                    'Por favor cont√°ctanos por WhatsApp para verificar manualmente.'
                );
            } else {
                showResult('error', 
                    'Error de conexi√≥n al verificar tu pedido.<br><br>' +
                    'Por favor intenta nuevamente o cont√°ctanos por WhatsApp.'
                );
            }
        }
    }

    async function verifyTransactionWithWompi(transactionId) {
        try {
            console.log('üåê Consultando API Wompi:', `${WOMPI_API_URL}${transactionId}`);
            
            const response = await fetch(`${WOMPI_API_URL}${transactionId}`);
            console.log('üìû Estado de la respuesta:', response.status);
            
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üìä Datos recibidos:', data);
            
            if (!data.data) {
                throw new Error('No se encontraron datos en la respuesta');
            }
            
            return data.data;
        } catch (error) {
            console.error('‚ùå Error en verifyTransactionWithWompi:', error);
            throw error;
        }
    }

    async function processRecoveredOrder(orderData, transaction) {
        console.log('‚úÖ Pedido recuperado - Procesando...', orderData);
        
        // Construir objeto para enviar a Sheets
        const orderDataToSend = {
            metadata: {
                orderNumber: orderData.ourReference || orderData.metadata?.orderNumber || `STBQ-${Date.now()}`,
                orderDate: new Date().toLocaleString('es-CO'),
                paymentMethod: `Wompi - ${transaction.payment_method_type || 'Tarjeta'}`,
                subtotal: Math.round(transaction.amount_in_cents / 100 * 0.85),
                shipping: Math.round(transaction.amount_in_cents / 100 * 0.15),
                total: transaction.amount_in_cents / 100,
                wompiReference: transaction.id,
                paymentStatus: 'approved',
                recovered: true,
                processedAt: new Date().toLocaleString('es-CO')
            },
            customer: {
                name: transaction.customer_data?.full_name || orderData.customer?.name || 'Cliente Wompi',
                email: transaction.customer_data?.email || orderData.customer?.email || 'cliente@wompi.com',
                phone: transaction.customer_data?.phone_number || orderData.customer?.phone || '3000000000',
                address: orderData.customer?.address || 'Por confirmar (Recuperado)',
                city: orderData.customer?.city || 'Por confirmar (Recuperado)',
                notes: 'Pedido recuperado autom√°ticamente via p√°gina de recuperaci√≥n'
            },
            items: orderData.items || [
                {
                    nombre: 'Productos Store Trends - Recuperado',
                    cantidad: 1,
                    precio_unitario: transaction.amount_in_cents / 100,
                    precio_total: transaction.amount_in_cents / 100,
                    marca: 'Store Trends'
                }
            ]
        };
        
        // Enviar a Google Sheets
        const sheetsResult = await submitOrderToSheets(orderDataToSend);
        
        if (sheetsResult && sheetsResult.success) {
            // Limpiar almacenamiento
            localStorage.removeItem('pendingWompiOrder');
            sessionStorage.removeItem('pendingWompiOrder');
            
            showResult('success', 
                `üéâ ¬°Tu pedido <strong>${orderDataToSend.metadata.orderNumber}</strong> fue procesado exitosamente!<br><br>
                ‚úÖ <strong>Estado:</strong> Aprobado<br>
                üí≥ <strong>Referencia Wompi:</strong> ${transaction.id}<br>
                üí∞ <strong>Total:</strong> $${(transaction.amount_in_cents / 100).toLocaleString()}<br>
                üìÖ <strong>Fecha:</strong> ${new Date(transaction.created_at).toLocaleString('es-CO')}<br><br>
                <strong>Tu pedido ha sido registrado en nuestro sistema.</strong>`
            );
        } else {
            showResult('error', 
                'El pago fue aprobado pero hubo un error registrando tu pedido.<br><br>' +
                'Por favor cont√°ctanos con tu referencia: ' + transaction.id
            );
        }
    }

    function submitOrderToSheets(orderData) {
        return new Promise((resolve) => {
            console.log('üì§ Enviando a Google Sheets...', orderData);
            
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyHu3rI_L_JeFJfO2W-3iDT1AbT4r57TybbqrHklY_dvnru8lilLRGo7_172AMhMnEvAQ/exec';
            
            fetch(scriptURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'orderData=' + encodeURIComponent(JSON.stringify(orderData))
            })
            .then(response => response.text())
            .then(text => {
                console.log('üì® Respuesta de Sheets:', text);
                try {
                    const data = JSON.parse(text);
                    resolve(data);
                } catch (e) {
                    console.log('üì® Respuesta no JSON, asumiendo √©xito');
                    resolve({ success: true, message: 'Pedido registrado' });
                }
            })
            .catch(error => {
                console.error('‚ùå Error enviando a Sheets:', error);
                resolve({ success: false, message: 'Error de conexi√≥n: ' + error.message });
            });
        });
    }

    function showResult(type, message) {
        const resultDiv = document.getElementById('result');
        const initialState = document.getElementById('initialState');
        
        if (initialState) initialState.classList.add('hidden');
        if (resultDiv) {
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }
    }
</script>
