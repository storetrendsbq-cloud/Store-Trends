<script>
    // ===== FUNCI√ìN PARA ENVIAR A GOOGLE SHEETS =====
    function submitOrderToSheets(orderData) {
        return new Promise((resolve) => {
            console.log('üì§ Enviando a Google Sheets:', orderData);
            
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyHu3rI_L_JeFJfO2W-3iDT1AbT4r57TybbqrHklY_dvnru8lilLRGo7_172AMhMnEvAQ/exec';
            const callbackName = 'sheetsCallback_' + Date.now();
            const script = document.createElement('script');
            
            const url = new URL(scriptURL);
            url.searchParams.append('callback', callbackName);
            url.searchParams.append('orderData', JSON.stringify(orderData));
            
            script.src = url.toString();
            
            window[callbackName] = function(response) {
                console.log('üì® Respuesta Google Sheets:', response);
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
                resolve(response);
            };
            
            script.onerror = function() {
                console.log('‚ùå Error cargando script JSONP');
                delete window[callbackName];
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
                resolve({ success: false, message: 'Error de conexi√≥n' });
            };
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (window[callbackName]) {
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.head.removeChild(script);
                    }
                    resolve({ success: false, message: 'Timeout' });
                }
            }, 15000);
        });
    }

    // ===== FUNCI√ìN PARA VERIFICAR TRANSACCI√ìN EN WOMPI =====
    async function checkWompiTransaction(transactionId) {
        try {
            console.log('üîç Verificando transacci√≥n en Wompi:', transactionId);
            
            // Usar la API de Wompi para verificar el estado real
            // NOTA: En producci√≥n necesitar√≠as tu private key, pero para testing podemos intentar con public key
            const response = await fetch(`https://production.wompi.co/v1/transactions/${transactionId}`);
            
            if (!response.ok) {
                throw new Error(`Error API Wompi: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('üìÑ Respuesta de Wompi API:', data);
            return data;
            
        } catch (error) {
            console.error('‚ùå Error verificando transacci√≥n:', error);
            // Si falla la API, intentamos una verificaci√≥n b√°sica por referencia
            return await checkTransactionByReference(transactionId);
        }
    }

    // ===== VERIFICACI√ìN ALTERNATIVA POR REFERENCIA =====
    async function checkTransactionByReference(reference) {
        try {
            console.log('üîç Verificando por referencia:', reference);
            // Esta es una verificaci√≥n b√°sica - en un caso real necesitar√≠as backend
            return { 
                data: { 
                    status: 'PENDING', // Por defecto asumimos pendiente hasta verificar
                    id: reference 
                } 
            };
        } catch (error) {
            console.error('Error en verificaci√≥n por referencia:', error);
            return { data: { status: 'UNKNOWN', id: reference } };
        }
    }

    // ===== DETECTAR ESTADO POR PAR√ÅMETROS URL =====
    function detectStatusFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const urlString = window.location.search;
        
        console.log('üîç Analizando URL para estado:', urlString);
        
        // Buscar patrones en la URL que indiquen error
        if (urlString.includes('error') || urlString.includes('declined') || urlString.includes('failed')) {
            return 'DECLINED';
        }
        
        if (urlString.includes('success') || urlString.includes('approved') || urlString.includes('completed')) {
            return 'APPROVED';
        }
        
        return 'UNKNOWN';
    }

    // ===== PROCESAR CUANDO LA P√ÅGINA CARGA =====
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üîÑ P√°gina de gracias cargada');
        
        // Obtener par√°metros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const orderNumber = urlParams.get('order');
        const wompiRef = urlParams.get('ref');
        const transactionId = urlParams.get('id'); // ID que Wompi pasa autom√°ticamente
        const env = urlParams.get('env');
        
        console.log('üìã Par√°metros URL:', { orderNumber, wompiRef, transactionId, env });
        
        // Actualizar UI b√°sica
        document.getElementById('orderNumber').textContent = orderNumber || 'No disponible';
        document.getElementById('wompiReference').textContent = wompiRef || 'No disponible';
        
        // Configurar WhatsApp
        const whatsappUrl = `https://wa.me/573054813630?text=Hola Store Trends, acabo de realizar un pedido (${orderNumber}) y quiero confirmar los detalles.`;
        document.getElementById('whatsappBtn').href = whatsappUrl;
        
        // üî• VERIFICAR ESTADO REAL DE LA TRANSACCI√ìN
        await verifyAndProcessOrder(orderNumber, wompiRef, transactionId);
    });

    async function verifyAndProcessOrder(orderNumber, wompiRef, transactionId) {
        try {
            let transactionStatus = 'UNKNOWN';
            
            // Intentar verificar por ID de transacci√≥n
            if (transactionId && transactionId !== 'undefined') {
                console.log('üîç Verificando con ID de transacci√≥n:', transactionId);
                const transactionData = await checkWompiTransaction(transactionId);
                transactionStatus = transactionData.data.status;
            } else {
                // Verificar por par√°metros de URL
                transactionStatus = detectStatusFromURL();
                console.log('üîç Estado detectado por URL:', transactionStatus);
            }
            
            console.log('üéØ Estado final de transacci√≥n:', transactionStatus);
            
            // Procesar seg√∫n el estado real
            if (transactionStatus === 'APPROVED') {
                await processApprovedOrder(orderNumber, wompiRef);
            } else if (transactionStatus === 'DECLINED' || transactionStatus === 'VOIDED' || transactionStatus === 'ERROR') {
                showDeclinedOrder(orderNumber, wompiRef, transactionStatus);
            } else {
                // Estado desconocido - mostrar mensaje neutral
                showUnknownStatus(orderNumber, wompiRef);
            }
            
        } catch (error) {
            console.error('‚ùå Error verificando orden:', error);
            showUnknownStatus(orderNumber, wompiRef);
        }
    }

    async function processApprovedOrder(orderNumber, wompiRef) {
        try {
            console.log('‚úÖ Procesando pedido APROBADO');
            
            // 1. Intentar obtener datos completos de sessionStorage
            let orderData = null;
            const pendingOrder = sessionStorage.getItem('pendingWompiOrder');
            
            if (pendingOrder) {
                orderData = JSON.parse(pendingOrder);
                console.log('‚úÖ Datos encontrados en sessionStorage:', orderData);
            } else {
                // 2. Si no hay datos, crear desde cero
                console.log('‚ÑπÔ∏è Creando datos b√°sicos desde URL');
                orderData = createBasicOrderData(orderNumber, wompiRef, 'approved');
            }

            // Actualizar metadata
            orderData.metadata.paymentStatus = 'approved';
            orderData.metadata.wompiReference = wompiRef;

            console.log('üì¶ Enviando pedido APROBADO a Google Sheets:', orderData);
            
            // Enviar a Google Sheets
            const sheetsResult = await submitOrderToSheets(orderData);
            
            if (sheetsResult.success) {
                console.log('‚úÖ Pedido registrado en Google Sheets');
                showSuccessMessage(orderNumber, wompiRef);
                // Limpiar sessionStorage
                sessionStorage.removeItem('pendingWompiOrder');
            } else {
                throw new Error(sheetsResult.message || 'Error en Google Sheets');
            }
            
        } catch (error) {
            console.error('‚ùå Error procesando pedido aprobado:', error);
            showSuccessWithWarning(orderNumber, wompiRef, 'Pedido aprobado pero no se pudo registrar autom√°ticamente. Por favor cont√°ctanos.');
        }
    }

    function showDeclinedOrder(orderNumber, wompiRef, status) {
        console.log('‚ùå Mostrando pedido DECLINADO:', status);
        
        document.getElementById('status').textContent = `‚ùå ${getStatusText(status)}`;
        document.getElementById('status').style.color = '#f44336';
        document.getElementById('processingMessage').classList.add('hidden');
        
        // Mensaje espec√≠fico para transacci√≥n declinada
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.classList.remove('hidden');
        errorDiv.innerHTML = `
            <p>‚ùå El pago no fue procesado correctamente.</p>
            <p><strong>Estado:</strong> ${getStatusText(status)}</p>
            <p>Por favor intenta con otro m√©todo de pago o contacta a tu entidad financiera.</p>
            ${wompiRef ? `<p><strong>Referencia:</strong> ${wompiRef}</p>` : ''}
        `;
        
        // Limpiar sessionStorage para pedidos declinados
        sessionStorage.removeItem('pendingWompiOrder');
        
        // Cambiar mensaje del bot√≥n de WhatsApp
        const whatsappBtn = document.getElementById('whatsappBtn');
        whatsappBtn.href = `https://wa.me/573054813630?text=Hola Store Trends, tuve un problema con mi pago (${orderNumber}) y necesito ayuda.`;
        whatsappBtn.innerHTML = 'üí¨ Solicitar ayuda';
    }

    function showUnknownStatus(orderNumber, wompiRef) {
        console.log('‚ùì Estado desconocido, mostrando mensaje neutral');
        
        document.getElementById('status').textContent = '‚è≥ Estado desconocido';
        document.getElementById('status').style.color = '#FF9800';
        document.getElementById('processingMessage').classList.add('hidden');
        
        // Mensaje neutral
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.classList.remove('hidden');
        errorDiv.innerHTML = `
            <p>‚è≥ No podemos verificar el estado de tu pago en este momento.</p>
            <p>Por favor contacta a soporte para confirmar el estado de tu pedido.</p>
            ${orderNumber ? `<p><strong>Pedido:</strong> ${orderNumber}</p>` : ''}
            ${wompiRef ? `<p><strong>Referencia:</strong> ${wompiRef}</p>` : ''}
        `;
        
        // Cambiar mensaje del bot√≥n de WhatsApp
        const whatsappBtn = document.getElementById('whatsappBtn');
        whatsappBtn.href = `https://wa.me/573054813630?text=Hola Store Trends, necesito verificar el estado de mi pedido ${orderNumber}`;
        whatsappBtn.innerHTML = 'üí¨ Verificar estado';
    }

    function showSuccessMessage(orderNumber, wompiRef) {
        document.getElementById('status').textContent = '‚úÖ Confirmado';
        document.getElementById('status').style.color = '#4CAF50';
        document.getElementById('processingMessage').classList.add('hidden');
        document.getElementById('successMessage').classList.remove('hidden');
    }

    function showSuccessWithWarning(orderNumber, wompiRef, message) {
        document.getElementById('status').textContent = '‚ö†Ô∏è Confirmado con observaciones';
        document.getElementById('status').style.color = '#FF9800';
        document.getElementById('processingMessage').classList.add('hidden');
        
        const successDiv = document.getElementById('successMessage');
        successDiv.classList.remove('hidden');
        successDiv.innerHTML = `
            <p>‚ö†Ô∏è ${message}</p>
            <p><strong>Pedido:</strong> ${orderNumber}</p>
            <p><strong>Referencia:</strong> ${wompiRef}</p>
            <p>Por favor cont√°ctanos para confirmar los detalles.</p>
        `;
    }

    function createBasicOrderData(orderNumber, wompiRef, status) {
        return {
            metadata: {
                orderNumber: orderNumber,
                orderDate: new Date().toLocaleString('es-CO'),
                paymentMethod: 'Wompi - Pago en l√≠nea',
                subtotal: 0,
                shipping: 0,
                total: 0,
                wompiReference: wompiRef,
                paymentStatus: status
            },
            customer: {
                name: 'Cliente Wompi',
                email: 'cliente@wompi.com',
                phone: '3000000000',
                address: 'Por confirmar',
                city: 'Por confirmar',
                notes: `Pago ${status} via Wompi`
            },
            items: [
                {
                    nombre: 'Productos varios - Estado por confirmar',
                    cantidad: 1,
                    precio_unitario: 0,
                    precio_total: 0,
                    marca: 'Store Trends'
                }
            ]
        };
    }

    function getStatusText(status) {
        const statusMap = {
            'APPROVED': 'Aprobado',
            'DECLINED': 'Declinado',
            'VOIDED': 'Cancelado',
            'ERROR': 'Error',
            'PENDING': 'Pendiente',
            'UNKNOWN': 'Desconocido'
        };
        return statusMap[status] || status;
    }
</script>
