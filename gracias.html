<script>
    // ===== CONFIGURACI√ìN WOMPI =====
    const WOMPI_PUBLIC_KEY = 'pub_test_Mv1l7L1UJH55WaT7ScivNlQ5AUaLjp7Q';
    const WOMPI_API_URL = 'https://sandbox.wompi.co/v1/transactions/';

    // ===== VERIFICACI√ìN CON API WOMPI =====
    async function verifyTransactionWithWompi(transactionId) {
        try {
            console.log('üîç Verificando transacci√≥n con Wompi API:', transactionId);
            
            const response = await fetch(`${WOMPI_API_URL}${transactionId}`);
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('üì° Respuesta API Wompi:', data);
            
            return data.data;
        } catch (error) {
            console.error('‚ùå Error verificando transacci√≥n:', error);
            return null;
        }
    }

    // ===== DETECCI√ìN CON API =====
    async function detectTransactionType() {
        const urlParams = new URLSearchParams(window.location.search);
        const idParam = urlParams.get('id');
        
        console.log('üîç Par√°metros URL:', Object.fromEntries(urlParams));

        // Si no hay ID, no podemos verificar
        if (!idParam) {
            console.log('‚ö†Ô∏è No hay ID de transacci√≥n - Asumiendo APROBADA');
            return 'approved';
        }

        // Verificar con API de Wompi
        const transactionData = await verifyTransactionWithWompi(idParam);
        
        if (!transactionData) {
            console.log('‚ö†Ô∏è No se pudo verificar con API - Asumiendo APROBADA');
            return 'approved';
        }

        // Verificar estado real de la transacci√≥n
        if (transactionData.status === 'APPROVED') {
            console.log('‚úÖ TRANSACCI√ìN APROBADA - Confirmada por API Wompi');
            return 'approved';
        } else {
            console.log('üö´ TRANSACCI√ìN DECLINADA - Estado:', transactionData.status);
            return 'declined';
        }
    }

    // ===== FUNCI√ìN PARA ENVIAR A GOOGLE SHEETS =====
    function submitOrderToSheets(orderData) {
        return new Promise((resolve) => {
            console.log('üì§ Enviando a Google Sheets...', orderData);
            
            const scriptURL = 'https://script.google.com/macros/s/AKfycbyHu3rI_L_JeFJfO2W-3iDT1AbT4r57TybbqrHklY_dvnru8lilLRGo7_172AMhMnEvAQ/exec';
            
            fetch(scriptURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'orderData=' + encodeURIComponent(JSON.stringify(orderData))
            })
            .then(response => response.text())
            .then(text => {
                console.log('üì® Respuesta de Sheets:', text);
                try {
                    const data = JSON.parse(text);
                    resolve(data);
                } catch (e) {
                    resolve({ success: true, message: 'Pedido registrado' });
                }
            })
            .catch(error => {
                console.error('‚ùå Error fetch:', error);
                resolve({ success: false, message: 'Error de conexi√≥n' });
            });
            
            setTimeout(() => {
                resolve({ success: false, message: 'Timeout en conexi√≥n' });
            }, 15000);
        });
    }

    // ===== REDIRECCI√ìN A ERROR =====
    function redirectToErrorPage(orderNumber, wompiRef, transactionId) {
        console.log('üîÄ Redirigiendo a p√°gina de error...');
        sessionStorage.removeItem('pendingWompiOrder');
        const errorUrl = `error.html?order=${orderNumber || ''}&ref=${wompiRef || ''}&id=${transactionId || ''}&status=DECLINED`;
        window.location.href = errorUrl;
    }

    // ===== PROCESAR PEDIDO APROBADO =====
    async function processWompiOrder(orderNumber, wompiRef) {
        try {
            console.log('üîç Buscando datos del pedido APROBADO...');
            
            let orderData = null;
            const pendingOrder = sessionStorage.getItem('pendingWompiOrder');
            
            if (pendingOrder) {
                orderData = JSON.parse(pendingOrder);
                console.log('‚úÖ Datos encontrados en sessionStorage');
            } else {
                console.log('‚ÑπÔ∏è Creando datos desde URL para aprobado');
                orderData = {
                    metadata: {
                        orderNumber: orderNumber,
                        orderDate: new Date().toLocaleString('es-CO'),
                        paymentMethod: 'Wompi - Pago en l√≠nea',
                        subtotal: 0,
                        shipping: 0,
                        total: 0,
                        wompiReference: wompiRef,
                        paymentStatus: 'approved'
                    },
                    customer: {
                        name: 'Cliente Wompi',
                        email: 'cliente@wompi.com',
                        phone: '3000000000',
                        address: 'Por confirmar',
                        city: 'Por confirmar',
                        notes: 'Pago realizado via Wompi'
                    },
                    items: [
                        {
                            nombre: 'Productos varios',
                            cantidad: 1,
                            precio_unitario: 0,
                            precio_total: 0,
                            marca: 'Store Trends'
                        }
                    ]
                };
            }

            orderData.metadata.paymentStatus = 'approved';
            orderData.metadata.wompiReference = wompiRef;

            console.log('üì¶ Enviando pedido APROBADO a Google Sheets...');
            
            const sheetsResult = await submitOrderToSheets(orderData);
            
            if (sheetsResult && sheetsResult.success) {
                console.log('‚úÖ Pedido APROBADO registrado en Google Sheets');
                showSuccess();
                sessionStorage.removeItem('pendingWompiOrder');
            } else {
                console.log('‚ö†Ô∏è Error en Sheets pero pedido fue aprobado');
                showSuccess();
                sessionStorage.removeItem('pendingWompiOrder');
            }
            
        } catch (error) {
            console.error('‚ùå Error procesando pedido aprobado:', error);
            showSuccess();
            sessionStorage.removeItem('pendingWompiOrder');
        }
    }

    // ===== FUNCIONES DE UI =====
    function showSuccess() {
        document.getElementById('status').textContent = '‚úÖ Confirmado';
        document.getElementById('status').style.color = '#4CAF50';
        document.getElementById('processingMessage').classList.add('hidden');
        document.getElementById('successMessage').classList.remove('hidden');
    }

    // ===== INICIALIZACI√ìN CON VERIFICACI√ìN API =====
    document.addEventListener('DOMContentLoaded', async function() {
        console.log('üîÑ P√°gina de gracias cargada - Verificando transacci√≥n...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const orderNumber = urlParams.get('order');
        const wompiRef = urlParams.get('ref');
        const idParam = urlParams.get('id');
        
        console.log('üìã Par√°metros URL:', { orderNumber, wompiRef, idParam });
        
        // Actualizar UI b√°sica
        document.getElementById('orderNumber').textContent = orderNumber || 'No disponible';
        document.getElementById('wompiReference').textContent = wompiRef || 'No disponible';
        
        // Configurar WhatsApp
        const whatsappBtn = document.getElementById('whatsappBtn');
        if (whatsappBtn) {
            const whatsappUrl = `https://wa.me/573054813630?text=Hola Store Trends, acabo de realizar un pedido (${orderNumber}) y quiero confirmar los detalles.`;
            whatsappBtn.href = whatsappUrl;
        }
        
        // üî• VERIFICACI√ìN CON API WOMPI
        const transactionType = await detectTransactionType();
        console.log('üí∞ Tipo de transacci√≥n final:', transactionType);
        
        if (transactionType === 'declined') {
            console.log('‚ùå Transacci√≥n declinada - Redirigiendo a error.html');
            redirectToErrorPage(orderNumber, wompiRef, idParam);
            return;
        }
        
        console.log('‚úÖ Transacci√≥n APROBADA - Continuando procesamiento');
        await processWompiOrder(orderNumber, wompiRef);
    });
</script>
